# 基本概念

## 消息系统

Kafka和传统的消息系统（也称消息中间件）都具备系统解耦、冗余存储、流量削峰、缓冲、异步通信、扩展性、可恢复性等功能。同时，Kafka海提供了大多数消息系统难以实现的消息顺序性保障以及回溯消费公嫩。

## 存储系统

Kafka 把消息持久化到磁盘，相比于其他基于内存存储的系统而言，有效地降低了数据丢失的风险。也正是得益于Kafka的消息持久化功能和多副本机制，我们可以把Kafka作为长期的数据存储系统来使用，只需要把对应的数据保留策略设置为“永久”或启用主题的日志压缩功能即可。

## 流式处理平台

Kafka 不仅为每个流行的流式处理框架提供了可靠的数据来源，还提供了一个完整的流式处理类库，比如窗口、连接、变换和聚合等各类操作。

## Producer

生产者，也就是发送消息的一方。生产者负责创建消息，然后将其投递到Kafka中

## Consumer

消费者，也就是消费消息的一方。消费者连接到Kafka上并接收消息，进而进行相应的业务处理逻辑。

## Broker

服务代理节点。对于Kafka而言，Broker可以简单地看作一个独立的Kafka服务节点货Kafka服务实例。大多数情况下也可以将Broker 看作一台Kafka服务器，前提是这台服务器上只部署了一个Kafka实例。一个或多个Broker组成了一个Kafka集群。一般而言，我们更习惯使用首字母小写的broker来表示服务代理节点。

> 一个典型的 Kafka 体系架构包括若干 Producer，若干 Consumer ，若干 Broker，以及一个ZooKeeper集群。其中ZooKeeper是用来负责集群元数据的管理，控制器的选举等操作的。Producer将消息发送到Broker，Broker 负责将收到的消息存储到磁盘中 ，而Consumer负责从Broker订阅并消费消息。

## 主题（Topic）

Kafka 中的消息是以主题为单位进行归类，生产者负责将消息发送到特定的主题（发送到Kafka集群中的每一条消息都要指定一个主题），而消费者订阅主题进行消费。

## 分区（Partition）

主题是一个逻辑上的概念，它还可以细分为多个分区，一个分区只属于单个主题，很多时候也会把分区称为主题分区（Topic-Partition）。同一主题下的不同分区包含的消息是不同的，分区在存储层面可以看作一个可追加的日志（log）文件，消息在被追加到分区日志文件到时候都会分配一个特定的偏移量（offset）。offset是消息在分区中的唯一标志，Kafka通过它来保证消息在分区内的顺序性，不过offset并不跨分区，也就是说，Kafka保证的是分区有序而非主题有序。

> 每一条消息被发送到Broker之前，会根据分区规则选择存储到哪个具体到分区。如果分区规则设定的合理，所有的消息都可以均匀的分配到不同的分区中。如果一个主题之对应一个文件，那么这个文件所在的机器I/O将会成为这个主题的性能瓶颈，而分区解决了这个问题。在创建主题的时候可以通过制定的参数来设置分区的个数，当然也可以在主题创建完成之后区修改分区的数量，通过增加分区数量可以实现水平扩展。

## 副本（Replica）

Kafka 为分区引入了多副本（Replica）机制，通过增加副本数量可以提升容灾能力。同一分区的不容副本中保存的是相同的消息（在同一时刻，副本之间并非完全一样），副本之间是“一主多从”的关系，其中leader副本负责处理读写请求，follower副本之负责与leader副本的消息同步。副本处于不同broker中，当leader副本出现故障时，从follower副本中重新选举新的leader副本对外提供服务。Kafka 通过多副本机制实现了故障的自动转移，当Kafka集群中的某个 broker 失效时仍然能保证服务可用。

> Kafka 消费端也具备一定的容灾能力。Consumer 使用拉（pull）模式从服务端拉取消息，并且保存消费的具体位置，当消费者宕机后恢复上线时可以根据之前保存的消费位置重新拉取需要的消息进行消费，不会造成消息丢失

## AR、ISR、OSR

分区中的所有副本被统称为AR（Assigned Replicas）。所有与leader副本保持一定程度同步的副本（包括leader副本在内）组成了ISR（In-Sync-Replicas），ISR集合时AR集合中的一个子集。消息会发送到leader副本，然后follower副本才能从leader副本中拉取消息进行同步，同步期间内 follower 副本相对于leader 副本而言会有一定程度的滞后。前面所说“一定程度的同步”是指可忍受的滞后范围，这个范围可以通过参数进行配置。与leader副本同步滞后过多的副本（不包括leader副本）组成OSR（Out-of-Sync Replicas），由此可见，AR = ISR + OSR。在正常情况下，所有的follower副本都应该与leader副本保持一定程度上的同步，即AR = ISR ， OSR == null。

> leader 副本负责维护和跟踪ISR集合中所有follower副本滞后状态，当follower副本落后太多或者失效时， leader 副本会把它从ISR集合中删除。如果OSR集合中有follower副本“追上”了 leader 副本，那么leader副本会把它从OSR集合转移至ISR集合。默认情况下，当leader副本发生故障时，只有在ISR集合中的副本才有资格被选举为新的leader，而OSR集合中的副本没有机会（可以通过相应的参数配置来改变）

## HW、LEO、LSO

HW 是 High Watermark 的缩写，俗称高水位，它标志了一个特定的消息偏移量（offset），消费者只能拉取到这个offset之前的消息。

LSO 是 LogStartOffset 的缩写，在日志文件中的第一条消息被称为LSO。

LEO 是 LogEndOffset 的缩写，他标识当前日志文件中下一条带写入消息的offset。

![分区中各种偏移量说明](https://raw.githubusercontent.com/Never12581/study-demo/master/other-file/picture/kafka/分区中各种偏移量说明.jpg)

