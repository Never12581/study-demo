# 数据库

## 服务器中的数据库

redis服务器将所有数据库都保存在服务器状态 redis.h/redisServer 结构的db数组中。db数组每一项都是 redis.h/redisDb 结构，每个redisDb代表一个数据库。

```c
struct redisServer{
  // ...
  // 一个数组，保存着服务器中所有数据库
  redisDb *db;
  // 服务器的数据库数量
  int dbnum;
}
```

dbnum属性的值由服务器配置的database选项决定，默认大小为16。

## 切换数据库

每个redis的客户端都有自己的目标数据库，每当客户端执行数据库写命令或者数据库读命令的时候，目标数据库就会成为这些命令的操作对象。

在服务器内部，客户端状态redisClient结构的db属性记录了客户端当前的目标数据库，这个属性是一个指向redisDb结构的指针：

```c
typedef struct redisClient{
  //···
  // 记录客户端当前正在使用的数据库
  redisDb *db;
  //···
}redisClient;
```

通过修改redisClient.db 指针，让它指向不同的数据库，从而实现切换目标数据库的功能，这就是select命令实现的原理。

## 数据库键空间

redis是一个键值对数据库，服务器中的每个数据都是由一个redis.h/redisDb 结构表示，其中，redisDB结构的dict字典保存了数据库中所有的键值对，我们将这个字典称为键空间：

```c
typedef struct redisDB{
  // ...
  // 数据库键空间
  dict *dict ;
  // ...
}redisDB;
```

键空间与用户所见的数据库是直接对应的：

- 键空间的键也就是数据库的键，每个键都是一个sds对象
- 键空间的值也就是数据库的值，每个值可以是sds，列表对象，哈希表对象，集合对象和有序集合对象中的任意一种redis对象

set、del、get、mset、······ 等各种命令，实际上就是对键空间的操作。除了这些基本操作以外，如flushdb、randomkey、dbsize、exists、rename、keys等命令也都是通过键值对空间来实现的。

### 读写键值对空间时的额外操作

当使用redis命令对数据库进行读写时，服务器不仅会对键空间执行指定的读写操作，还会执行一些额外的维护操作，其中包括：

- 在读取一个键之后（读操作和谢操作都要对键进行读取），服务器会根据键是否存在来更新服务器的键空间命中（hit）次数或者键空间不命中（miss）次数，这两个值可以在info status命令的 keyspace_hits 属性和 keyspace_misses 属性中查看
- 在读取一个键之后，服务器会更新键的LRU（最后一次使用时间），这个值可以用于计算键的闲置时间，使用OBJECT idletime <key> 命令可以查看键的闲置时间
- 如果服务器在读取一个键时发现该键已经过期，那么服务器会先删除这个过期键，然后才执行余下操作
- 如果有客户端用watch命令监视了某个键，那么服务器在对被监视的键进行修改之后，会将该键标记为脏（dirty），从而让事务程序注意到这个键已经被修改过了
- 服务器每修改一个键后，都会对脏（dirty）键计数器的值加1，这个计数器会触发服务器的持久化以及复制操作
- 如果服务器开启了数据库通知功能，那么在对键进行修改之后，服务器将按配置发送相应的数据库通知